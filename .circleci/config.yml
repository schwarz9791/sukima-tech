# Javascript Node CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-javascript/ for more details
#
version: 2
jobs:
  build:
    docker:
      - image: circleci/node:10.12.0-stretch-browsers-legacy
    working_directory: ~/repo

    steps:
      - checkout

      # Download and cache dependencies
      - restore_cache:
        name: Restore Yarn Package Cache
        keys:
          - yarn-packages-{{ checksum "yarn.lock" }}
      - run:
        name: Install Dependencies
        command: yarn install --frozen-lockfile

      - save_cache:
        name: Save Yarn Package Cache
        key: yarn-packages-{{ checksum "yarn.lock" }}
        paths:
          - ~/.cache/yarn

  test:
    docker:
      - image: circleci/node:10.12.0-stretch-browsers-legacy
    working_directory: ~/repo

    steps:
      # run tests!
      # - run: yarn test

  deploy-staging:
    docker:
      - image: circleci/node:10.12.0-stretch-browsers-legacy
    working_directory: ~/repo

    steps:
      - run:
        name: Generate Nuxt app
        command: yarn generate

      - run:
        name: Deploy Master to Firebase
        command: ./node_modules/.bin/firebase use stg
        command: ./node_modules/.bin/firebase deploy --token=$FIREBASE_TOKEN

  deploy-production:
    docker:
      - image: circleci/node:10.12.0-stretch-browsers-legacy
    working_directory: ~/repo

    steps:
      - run:
        name: Generate Nuxt app
        command: yarn generate:prod

      - run:
        name: Deploy Master to Firebase
        command: ./node_modules/.bin/firebase use prod
        command: ./node_modules/.bin/firebase deploy --token=$FIREBASE_TOKEN


workflows:
  version: 2
  build-deploy:
    jobs:
      - build
      - test:
        requires:
          - build
      - deploy-staging:
        requires:
          - test
        filters:
          branches:
            only: staging
      - deploy-production:
        requires:
          - test
        filters:
          branches:
            only: master


